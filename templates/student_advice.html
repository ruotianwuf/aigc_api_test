<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Advice</title>

     <style>

        body {
            background-image: url("../static/img/student_back.jpg");
            color: black;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            font-family: 'SimSun', 'Songti SC', 'serif';
            padding: 20px;
        }


     /* 公共样式 */
.message {
    display: flex;
    flex-direction: column;
    padding: 10px;
    border-radius: 20px;
    margin-bottom: 10px;
    word-wrap: break-word;
    align-items: flex-start;
    width: fit-content;
    max-width: 50%;
}


.user-message {
    display: none;
    background-color: white;
    color: black;
    margin-left: auto;
    margin-right: 200px;
    margin-top: 10px;
    border: 1px solid #ddd;
    align-items: flex-end;
}


.ai-message {
    display: none;
    background-color: #3333cc;
    color: white;
    margin-right: auto;
    margin-left: 200px;
    border: 1px solid #ddd;
    align-items: flex-start;
}


.avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-bottom: 5px;
}


.name {
    font-weight: bold;
    margin-bottom: 5px;
}


.text {
    max-width: 100%;
    margin: 0;
}

.black-background {
    width: 80%;
    background-color: lightskyblue;
    color: black;
    padding: 10px;
    border-radius: 5px;
    margin: auto;
    font-weight: 600;
}

.chat-box{
    margin-top: 15px;
    text-align: center;
}
.page-title {
    text-align: center; /* 文本居中对齐 */
    font-size: 60px; /* 字体大小 */
    font-weight: 1000; /* 字体加粗 */
    margin-bottom: 20px; /* 底部边距 */
}

.return-button {
            position: fixed; /* 绝对定位 */
            right: 130px; /* 距离页面右侧20px */
            bottom: 60px; /* 距离页面底部20px */
            padding: 10px 20px; /* 按钮的内边距 */
            background-color: lawngreen; /* 按钮的背景颜色 */
            color: white; /* 按钮的文字颜色 */
            border: black; /* 移除边框 */
            border-radius: 5px; /* 圆角边框 */
            cursor: pointer; /* 鼠标悬停时显示手形图标 */
            transform: scale(1.5);
        }

        .return-button:hover {
            background-color: #005f73; /* 鼠标悬停时按钮的背景颜色 */
        }

    </style>

</head>
<body>
<h1 class="page-title">个人学业助手</h1>

<div class="content-box" id="content">

</div>

<div class="message user-message" id="questionDisplay">
    <img src="../static/img/student.png" alt="User Avatar" class="avatar">
    <div class="name">You</div>
    <div class="text"></div>
</div>
<div class="message ai-message" id="answerDisplay">
    <img src="../static/img/AI%20UI.png" alt="AI Avatar" class="avatar">
    <div class="name">Assistant</div>
    <div class="text"></div>
</div>

    <button onclick="backhome()" class="return-button">返回</button>

<div class="chat-box">
    <input id="questionInput" ty  pe="text" placeholder="输入消息..." style="width: 80%; padding: 8px; border: none; border-radius: 5px;">
    <button onclick="question()" style="padding: 8px 16px; background-color: #555; color: white; border: none; border-radius: 5px;">发送</button>
</div>

</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    var cookies = document.cookie.split("; ");
            for (var i = 0; i < cookies.length; i++) {
                var cookiePair = cookies[i].split("=");
                if (cookiePair[0] === "student" && cookiePair[1]) {
                    var data = {"username": cookiePair[1]};
                    // alert(JSON.stringify(data));
                    $.ajax({
                      url: "/answer_msg/advice",
                        type: "POST",
                        data: JSON.stringify(data),
                        contentType: "application/json",
                        dataType: "json",
                        success: function(response) {
                            if (response.success) {
                                var replay = response.result


                                replay = replay.replace(/(\d+)\. /g, '$1.');
                                replay = replay.replace(/\((\d+)\) /g, '($1)');
                                replay = replay.replace(/(①|②|③|④|⑤|⑥)/g, '$1 ');
                                replay = replay.replace(/\n/g, '<br>');


                                var outputDiv = document.getElementById("content");
                                outputDiv.innerHTML = "<div class='"+"black-background"+"'>" + replay + "</div>";
                                }
                        },
                        error: function() {
                            alert("错误error");
                        }
                    });
                }
            }


    document.getElementById("questionInput").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            question();
        }
    });

  function question() {
    var questionInput = document.getElementById("questionInput");
    var questionText = questionInput.value.trim();
    if (questionText) {
        var data = { 'question': questionText };
        $.ajax({
            url: "/answer_msg",
            type: "POST",
            data: JSON.stringify(data),
            contentType: "application/json",
            dataType: "json",
            success: function(response) {
                if (response.success) {
                    var formattedAnswer = response.result;
                    formattedAnswer = formattedAnswer.replace(/(\d+)\. /g, '$1. ');
                    formattedAnswer = formattedAnswer.replace(/\((\d+)\) /g, '($1)');
                    formattedAnswer = formattedAnswer.replace(/(①|②|③|④|⑤|⑥) /g, '$1 ');
                    formattedAnswer = formattedAnswer.replace(/\n/g, '<br>');
                    var outputDiv = document.getElementById("content");
                    var questionHTML = "<div class='message user-message' style='display: flex;'>" +
                                       "<img src='../static/img/student.png' alt='User Avatar' class='avatar'>" +
                                       "<div>" +
                                         "<div class='name'>You</div>" +
                                         "<div class='text'>" +  data.question + "</div>" +
                                       "</div>" +
                                       "</div>";
                    var answerHTML = "<div class='message ai-message' style='display: flex;'>" +
                                     "<img src='../static/img/AI UI.png' alt='AI Avatar' class='avatar'>" +
                                     "<div>" +
                                       "<div class='name'>Assistant</div>" +
                                       "<div class='text'>" + formattedAnswer + "</div>" +
                                     "</div>" +
                                     "</div>";
                    outputDiv.innerHTML += questionHTML + answerHTML;
                    questionInput.value = "";
                } else {
                    alert("未能获取到答案。");
                }
            },
            error: function(xhr, status, error) {
                alert("发生错误，请稍后重试。");
            }
        });
    } else {
        alert("问题不能为空。");
    }
}

function backhome() {
                var cookies = document.cookie.split("; ");
                for (var i = 0; i < cookies.length; i++) {
                var cookiePair = cookies[i].split("=");
                if (cookiePair[0] === "student" && cookiePair[1]) {
                    var dataToSend = cookiePair[1];
                    var url = "http://127.0.0.1:5000/student?data=" + dataToSend;
                    window.location.href = url;
                }
            }
        }


// 获取页面上一次滚动的位置
var lastScrollPosition = window.scrollY;

// 设置定时器，每隔一定时间调用一次 scrollToBottom 函数
var scrollInterval = setInterval(scrollToBottom, 1000); // 每秒钟调用一次，可以根据需要调整时间间隔

// 监听滚动事件
window.addEventListener('scroll', function() {
    // 获取当前页面滚动的位置
    var currentScrollPosition = window.scrollY;

    // 判断用户是向下滚动还是向上滚动
    if (currentScrollPosition < lastScrollPosition) {
        // 向下滚动，清除定时器
        clearInterval(scrollInterval);

        // 设置一个延时，之后重新开始自动滚动
        setTimeout(function() {
            // 重新启动定时器
            scrollInterval = setInterval(scrollToBottom, 1000); // 重新启动定时器
        }, 200000); // 停止滚动 3 秒后重新开始
    }

    // 更新上一次滚动的位置
    lastScrollPosition = currentScrollPosition;
});

// 将页面滚动到底部
function scrollToBottom() {
    window.scrollTo(0, document.body.scrollHeight);
}



</script>
</html>